#include <string.h>
#include "user.h"

static uchar pat[21][8] = { 
{0xE8, 0x88, 0xC8, 0x8F, 0x85, 0x77, 0x51, 0x7B},	// タイトル
{0x00, 0x0E, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0E}, //0
{0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02}, //1	
{0x00, 0x0E, 0x02, 0x02, 0x0E, 0x08, 0x08, 0x0E}, //2
{0x00, 0x0E, 0x02, 0x02, 0x0E, 0x02, 0x02, 0x0E}, //3	
{0x00, 0x0A, 0x0A, 0x0A, 0x0E, 0x02, 0x02, 0x02}, //4		
{0x00, 0x0E, 0x08, 0x08, 0x0E, 0x02, 0x02, 0x0E}, //5
{0xFF, 0x00, 0xA1, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x63, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00, 0x80},		
{0xFF, 0x00, 0xB5, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x80},
{0xFF, 0x00, 0xA7, 0x00, 0x00, 0x00, 0x00, 0x80},
{0xFF, 0x00, 0x58, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x7A, 0x00, 0x00, 0x00, 0x00, 0x80},
{0xFF, 0x00, 0x6B, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x80},	
{0xFF, 0x00, 0x2D, 0x00, 0x00, 0x00, 0x00, 0x80},
{0xFF, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x00, 0x80},
{0xFF, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x80},
};

void user_init(void)
{
	_sound(33, 2);
}


void user_main(void)
{
	static char stat = 0, cnt = 0, n = 0 ,gide = 0,pos = 0,push=0,p1=0,p2=0,p3=0,p4=0,p5=0,p6=0,p7=0,p8=0,win=0;
	switch (stat) {
	case 0:	// タイトル画面
		n = 0;
		if (sw_flag) {
			sw_flag = 0;
			switch (sw) {
			case 1:
				n = _rand() % 15 + 7;
				stat = 1;
				_sound(30, 1);
				break;
			case 2:
				n = _rand() % 15 + 7;
				stat = 1;
				_sound(30, 1);
				break;
			}
		}
		goto draw;
	case 1:	//ゲーム画面
		cnt++;
		if (cnt == 10){
			cnt = 0;	
			gide++;
			}
		if(led[0] == 0x00 && gide > 2){
			stat = 2;
			_sound(250, 1);
			}
		if (sw_flag) {
			sw_flag = 0;
			switch (sw) {
			case 1:
				if(pos == 0){
					pos = 8;}
				pos--;

				break;
			case 2:
				pos++;
				if(pos == 8){
					pos = 0;}
				break;
			case 3:
				_sound(30, 1);
				if (pos ==0){
					p1++;
					if(p1==2){
						p1=0;}
					}
				if (pos ==1){
					p2++;
					if(p2==2){
						p2=0;}
					}				
				if (pos ==2){
					p3++;
					if(p3==2){
						p3=0;}
					}
				if (pos ==3){
					p4++;
					if(p4==2){
						p4=0;}
					}
				if (pos ==4){
					p5++;
					if(p5==2){
						p5=0;}
					}
				if (pos ==5){
					p6++;
					if(p6==2){
						p6=0;}
					}				
				if (pos ==6){
					p7++;
					if(p7==2){
						p7=0;}
					}
				if (pos ==7){
					p8++;
					if(p8==2){
						p8=0;}
					}	
				break;
			}
		}
		goto draw;
	case 2:	// サイコロ停止
		n = win +1;
		cnt++;
		if(cnt==30){
		cnt=0;
		stat=0;
		gide=0;
		win = 0;
		}
		goto draw;
	}
  draw:

	memcpy(led, pat[n], 8);
		if (gide >= 1) {
		led[0] >>= gide;
	}
	if(stat ==1){
	led[7] >>= pos;
	}
	if(stat==1){
		if(p1==1){
			led[5] |= 0x80;
		}
		if(p2==1){
			led[5] |= 0x40;
		}
		if(p3==1){
			led[5] |= 0x20;
		}
		if(p4==1){
			led[5] |= 0x10;
		}
		if(p5==1){
			led[5] |= 0x08;
		}
		if(p6==1){
			led[5] |= 0x04;
		}
		if(p7==1){
			led[5] |= 0x02;
		}
		if(p8==1){
			led[5] |= 0x01;
		}
	}

	if(led[2] == led[5] && stat == 1){
	win++;
	gide = 0;
	stat =1;
	n = _rand() % 15 + 7;
	if(win==5){
		_sound(33, 2);
	pos=0;
	gide=0;
	stat = 2;}
	}
}
